<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NetMarket OS - TITAN V8 Hybrid (Workflow Suite)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#d4af37; --primary-dim: rgba(212,175,55,.15);
      --bg-deep:#0b0c10; --bg-sidebar:#111418; --bg-panel:#1a1d21;
      --border:#2d3238; --text-main:#e0e6ed; --text-muted:#949ba3;
      --success:#51cf66; --danger:#ff6b6b; --info:#4dabf7; --warn:#ffd43b;
      --font-ui:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --node-bg:#151a20;
      --node-stroke:#2b3138;
      --node-text:#d6dde6;
      --grid: rgba(255,255,255,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg-deep);color:var(--text-main);font-family:var(--font-ui);height:100vh;display:flex;overflow:hidden}

    /* LAYOUT */
    .sidebar{width:270px;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:10;padding:10px}
    .main-wrapper{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
    .top-bar{height:60px;border-bottom:1px solid var(--border);background:var(--bg-sidebar);display:flex;align-items:center;justify-content:space-between;padding:0 22px}
    .content-area{flex:1;overflow-y:auto;padding:26px}

    /* COMPONENTS */
    .brand{padding:15px;font-family:'Playfair Display',serif;font-size:1.4rem;color:#fff;display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .brand i{color:var(--primary)}
    .nav-label{font-size:.7rem;text-transform:uppercase;color:var(--text-muted);font-weight:700;margin:15px 0 6px 10px}
    .nav-item{padding:10px 15px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:.92rem;color:var(--text-muted);margin-bottom:4px;transition:.2s}
    .nav-item:hover,.nav-item.active{background:var(--primary-dim);color:var(--primary);border-left:3px solid var(--primary)}
    .grid-4{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:16px}
    .card{background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;box-shadow:var(--shadow)}
    .card h3{margin-bottom:12px}
    .stat-val{font-size:2rem;font-weight:800;color:#fff;font-family:var(--font-code);margin:10px 0}
    .muted{color:var(--text-muted)}
    .mono{font-family:var(--font-code)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--border);font-size:.78rem;color:#cbd5e1;background:#0f1216}
    .pill.ok{border-color:rgba(81,207,102,.35);color:var(--success)}
    .pill.bad{border-color:rgba(255,107,107,.35);color:var(--danger)}
    .pill.info{border-color:rgba(77,171,247,.35);color:var(--info)}
    .pill.warn{border-color:rgba(255,212,59,.35);color:var(--warn)}
    .btn{background:var(--primary);color:#000;border:none;padding:9px 14px;border-radius:9px;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#fff}
    .btn.secondary{background:transparent;color:var(--text-main);border:1px solid var(--border);font-weight:650}
    .btn.secondary:hover{border-color:rgba(212,175,55,.5);color:var(--primary)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input,.select{
      background:#0f1216;border:1px solid var(--border);color:var(--text-main);
      padding:9px 10px;border-radius:10px;outline:none
    }
    .input{min-width:240px}
    .hr{height:1px;background:var(--border);margin:14px 0}

    /* TABLE */
    .data-table{width:100%;border-collapse:collapse;margin-top:8px}
    .data-table th{text-align:left;padding:10px;color:var(--text-muted);border-bottom:1px solid var(--border);font-size:.78rem}
    .data-table td{padding:10px;border-bottom:1px solid #333;color:#d1d5db;font-size:.88rem}
    .td-right{text-align:right}
    .empty{padding:18px;color:#777;text-align:center;border:1px dashed #2c3036;border-radius:12px;background:#0f1216}

    /* VIEW SECTIONS */
    .view-section{display:none;animation:fadeIn .28s}
    .view-section.active{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* TOASTS */
    .toasts{position:fixed;bottom:16px;right:16px;z-index:5000;display:flex;flex-direction:column;gap:10px}
    .toast{
      width:min(440px, calc(100vw - 32px));
      background:#0f1216;border:1px solid var(--border);border-left:4px solid var(--info);
      border-radius:12px;padding:12px 12px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:flex-start
    }
    .toast.ok{border-left-color:var(--success)}
    .toast.bad{border-left-color:var(--danger)}
    .toast.warn{border-left-color:var(--warn)}
    .toast .t-title{font-weight:900;margin-bottom:2px}
    .toast .t-msg{color:#cbd5e1;font-size:.9rem}
    .toast .t-close{margin-left:auto;background:transparent;border:none;color:#cbd5e1;cursor:pointer;font-size:1.1rem}
    .toast .t-close:hover{color:#fff}

    /* WORKFLOW CANVAS (n8n-like) */
    .wf-wrap{display:grid;grid-template-columns: 1.35fr .65fr;gap:16px}
    @media(max-width:1050px){.wf-wrap{grid-template-columns:1fr}}
    .wf-canvas{
      position:relative;height:560px;border-radius:14px;border:1px solid var(--border);
      background:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px),
        #0f1216;
      background-size: 26px 26px;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .wf-svg{position:absolute;inset:0;pointer-events:none}
    .wf-nodes{position:absolute;inset:0}
    .node{
      position:absolute;min-width:170px;max-width:220px;
      background:var(--node-bg);
      border:1px solid var(--node-stroke);
      border-radius:12px;
      padding:10px 10px;
      display:flex;gap:10px;align-items:flex-start;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      cursor:grab;
      user-select:none;
      transition:.18s;
    }
    .node .ic{
      width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:#0f1216;border:1px solid #2a2f35;color:#cbd5e1;
      flex:0 0 34px;
    }
    .node .t{
      display:flex;flex-direction:column;gap:2px;
      color:var(--node-text);
      min-width:0;
    }
    .node .t .title{font-weight:900;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .node .t .sub{font-size:.76rem;color:#9aa3ad;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .node .badge{
      margin-left:auto;
      font-size:.72rem;
      padding:4px 8px;border-radius:999px;border:1px solid #2a2f35;color:#cbd5e1;background:#0f1216;
      align-self:flex-start;
    }
    .node.active{transform:scale(1.02);border-color:rgba(212,175,55,.7);box-shadow: 0 0 0 2px rgba(212,175,55,.25), 0 10px 26px rgba(0,0,0,.45)}
    .node.ok{border-color:rgba(81,207,102,.55)}
    .node.warn{border-color:rgba(255,212,59,.55)}
    .node.fail{border-color:rgba(255,107,107,.65)}
    .node .badge.ok{color:var(--success);border-color:rgba(81,207,102,.35)}
    .node .badge.warn{color:var(--warn);border-color:rgba(255,212,59,.35)}
    .node .badge.fail{color:var(--danger);border-color:rgba(255,107,107,.35)}
    .node .badge.idle{color:#9aa3ad}

    .wf-panel{display:flex;flex-direction:column;gap:14px}
    .wf-panel .card{height:100%}
    .wf-mini{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .wf-mini .mini{
      background:#0f1216;border:1px solid var(--border);border-radius:12px;padding:12px;
    }
    .wf-mini .mini .k{color:#9aa3ad;font-size:.78rem}
    .wf-mini .mini .v{margin-top:6px;color:#fff;font-weight:900;font-family:var(--font-code);font-size:1.1rem}

    .wf-term{
      background:#050505;border:1px solid #222;border-radius:12px;padding:12px;height:210px;overflow:auto;
      font-family:var(--font-code);font-size:.82rem;color:#33ff00;
    }
    .term-line{margin-bottom:6px;opacity:0;animation:slideIn .18s forwards;display:flex;gap:10px}
    .term-time{color:#555;white-space:nowrap}
    .term-text{color:#ddd}
    @keyframes slideIn{from{transform:translateX(10px);opacity:0}to{transform:translateX(0);opacity:1}}

    /* LOGS + AUDIT */
    .split{display:grid;grid-template-columns: 1.15fr .85fr;gap:16px}
    @media(max-width:1050px){.split{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-cube"></i> NetMarket
      <span style="font-size:.62rem;border:1px solid var(--primary);padding:2px 6px;border-radius:8px;margin-left:5px;">TITAN V8</span>
    </div>

    <div class="nav-label">Général</div>
    <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>

    <div class="nav-label">Outils Métiers</div>
    <div class="nav-item" onclick="nav('design', this)"><i class="fas fa-pencil-ruler"></i> NetDesignX</div>
    <div class="nav-item" onclick="nav('cat', this)"><i class="fas fa-tags"></i> NetCatX</div>
    <div class="nav-item" onclick="nav('promo', this)"><i class="fas fa-bullhorn"></i> NetMarkX</div>
    <div class="nav-item" onclick="nav('care', this)"><i class="fas fa-headset"></i> NetCareX</div>

    <div class="nav-label">Ops</div>
    <div class="nav-item" onclick="nav('ops', this)"><i class="fas fa-shield-halved"></i> Audit & Conformité</div>

    <div style="margin-top:auto;font-size:.78rem;color:#555;padding:10px;">
      System Status: <span style="color:var(--success)">● Online</span><br>
      Server: AWS-Paris-1<br>
      Build: <span class="mono">titan-v8.workflow-suite</span>
    </div>
  </aside>

  <div class="main-wrapper">
    <header class="top-bar">
      <div style="font-weight:900" id="pageTitle">Dashboard</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:.85rem;color:var(--text-muted);" id="clock">--:--:--</span>
        <span class="pill info"><i class="fas fa-bolt"></i> Démo (n8n-like)</span>
        <span style="font-size:.85rem;color:var(--text-muted);">Admin User</span>
        <div style="width:30px;height:30px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#000;font-weight:900;">A</div>
      </div>
    </header>

    <div class="content-area">
      <!-- DASHBOARD -->
      <section id="dashboard" class="view-section active">
        <div class="toolbar">
          <div class="toolbar-left">
            <span class="pill ok"><i class="fas fa-heart-pulse"></i> Uptime 99.98%</span>
            <span class="pill info"><i class="fas fa-arrows-rotate"></i> Sync 2m</span>
            <span class="pill warn"><i class="fas fa-triangle-exclamation"></i> 1 alerte</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="exportLogsCSV()"><i class="fas fa-file-export"></i> Export Logs</button>
            <button class="btn" onclick="toast('ok','Snapshot','Rapport KPI généré (démo).')"><i class="fas fa-camera"></i> Snapshot</button>
          </div>
        </div>

        <h2 style="margin-bottom:14px;color:#fff;">Vue d'Ensemble</h2>

        <div class="grid-4">
          <div class="card">
            <div class="muted">Chiffre d'Affaires</div>
            <div class="stat-val" id="kpiCA">11.1 Mds</div>
            <div style="color:var(--success);font-size:.82rem;">▲ +7% Annuel</div>
          </div>
          <div class="card">
            <div class="muted">Visiteurs Actifs</div>
            <div class="stat-val" id="kpiVisitors">45,200</div>
            <div style="color:var(--success);font-size:.82rem;">▲ +12% vs Hier</div>
          </div>
          <div class="card">
            <div class="muted">Commandes / Jour</div>
            <div class="stat-val" id="kpiOrders">8,450</div>
            <div style="color:var(--info);font-size:.82rem;">● Stable</div>
          </div>
          <div class="card">
            <div class="muted">Taux Retour</div>
            <div class="stat-val" id="kpiReturns">14%</div>
            <div style="color:var(--danger);font-size:.82rem;">▼ -2% (Objectif)</div>
          </div>
        </div>

        <div class="split">
          <div class="card">
            <div class="toolbar" style="margin-bottom:6px;">
              <div class="toolbar-left">
                <h3 style="margin:0;">Flux d'Activité (Logs)</h3>
                <span class="pill info"><i class="fas fa-database"></i> Event Stream</span>
              </div>
              <div class="toolbar-right">
                <input class="input" id="logSearch" placeholder="Rechercher: module, action, détail..." oninput="renderLogs()" />
                <select class="select" id="logFilter" onchange="renderLogs()">
                  <option value="ALL">Tous modules</option>
                  <option value="NetDesignX">NetDesignX</option>
                  <option value="NetCatX">NetCatX</option>
                  <option value="NetMarkX">NetMarkX</option>
                  <option value="NetCareX">NetCareX</option>
                  <option value="OPS">OPS</option>
                </select>
              </div>
            </div>

            <table class="data-table">
              <thead>
                <tr><th>Horodatage</th><th>Module</th><th>Action</th><th>Détail</th><th class="td-right">Statut</th></tr>
              </thead>
              <tbody id="logsBody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>KPIs Inter-Départements</h3>
            <div class="hr"></div>
            <div style="display:grid;gap:12px;">
              <div><div class="muted">Time-to-market (Design→Live)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiTTM">—</div></div>
              <div><div class="muted">Data Quality PIM (erreurs)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiDQ">—</div></div>
              <div><div class="muted">ROI Marketing (7j)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiROI">—</div></div>
              <div><div class="muted">SLA Support (24h)</div><div class="mono" style="font-size:1.25rem;font-weight:900;color:#fff" id="kpiSLA">—</div></div>
            </div>
            <div class="hr"></div>
            <button class="btn" onclick="recalcEnterpriseKPIs()"><i class="fas fa-wand-magic-sparkles"></i> Recalculer</button>
          </div>
        </div>
      </section>

      <!-- NETDESIGNX -->
      <section id="design" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetDesignX <span style="color:#666;font-size:1rem;">| Design & Collection</span></h2>
            <span class="pill info"><i class="fas fa-diagram-project"></i> Workflow n8n</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="loadWorkflow('design')"><i class="fas fa-rotate"></i> Charger workflow</button>
            <button class="btn" onclick="runWorkflow('design')"><i class="fas fa-play"></i> Exécuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Idées</div><div class="stat-val" id="dIdeas">42</div><span class="pill ok">Backlog sain</span></div>
          <div class="card"><div class="muted">Prototypes 3D</div><div class="stat-val" id="dProto">15</div><span class="pill info">CLO3D</span></div>
          <div class="card"><div class="muted">Lead time validation</div><div class="stat-val" id="dLead">3.2 j</div><span class="pill warn">À optimiser</span></div>
          <div class="card"><div class="muted">Taux complétude 1er passage</div><div class="stat-val" id="dFirstPass">81%</div><span class="pill info">Gate “Validation”</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-canvas" id="wfCanvasDesign">
            <svg class="wf-svg" id="wfSvgDesign"></svg>
            <div class="wf-nodes" id="wfNodesDesign"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
                <div class="toolbar-right">
                  <button class="btn secondary" onclick="wfSpeedToggle()"><i class="fas fa-gauge-high"></i> Vitesse: <span id="wfSpeedLbl">x1</span></button>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini">
                  <div class="k">Cycle time (croquis→Go)</div>
                  <div class="v" id="dKpiCycle">—</div>
                </div>
                <div class="mini">
                  <div class="k">Taux No-Go</div>
                  <div class="v" id="dKpiNoGo">—</div>
                </div>
                <div class="mini">
                  <div class="k">Tickets IT</div>
                  <div class="v" id="dKpiTickets">—</div>
                </div>
                <div class="mini">
                  <div class="k">Handoff vers PIM</div>
                  <div class="v" id="dKpiHandoff">—</div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermDesign"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETCATX -->
      <section id="cat" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetCatX <span style="color:#666;font-size:1rem;">| Catalogue / E-merchandising</span></h2>
            <span class="pill info"><i class="fas fa-tags"></i> PIM + Publication</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="loadWorkflow('cat')"><i class="fas fa-rotate"></i> Charger workflow</button>
            <button class="btn" onclick="runWorkflow('cat')"><i class="fas fa-play"></i> Exécuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Produits Live</div><div class="stat-val" id="cLive">12,400</div><span class="pill ok">Stable</span></div>
          <div class="card"><div class="muted">Complétude</div><div class="stat-val" id="cComp">98.7%</div><span class="pill ok">Très bon</span></div>
          <div class="card"><div class="muted">Time-to-publish</div><div class="stat-val" id="cPub">14 min</div><span class="pill info">Pipeline API</span></div>
          <div class="card"><div class="muted">Erreurs / 1000 SKU</div><div class="stat-val" id="cErrRate">0.8</div><span class="pill warn">Qualité</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-canvas" id="wfCanvasCat">
            <svg class="wf-svg" id="wfSvgCat"></svg>
            <div class="wf-nodes" id="wfNodesCat"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">Succès sync (%)</div><div class="v" id="cKpiSync">—</div></div>
                <div class="mini"><div class="k">Doublons gérés</div><div class="v" id="cKpiDup">—</div></div>
                <div class="mini"><div class="k">Dead-letter</div><div class="v" id="cKpiDLQ">—</div></div>
                <div class="mini"><div class="k">Publication</div><div class="v" id="cKpiPublish">—</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermCat"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETMARKX (Marketing) -->
      <section id="promo" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetMarkX <span style="color:#666;font-size:1rem;">| Marketing & Communication</span></h2>
            <span class="pill info"><i class="fas fa-bullseye"></i> Automation & ROI</span>
          </div>
          <div class="toolbar-right">
            <select class="select" id="segmentSelect" onchange="updateSegment()">
              <option value="VIP">Segment VIP (>200€)</option>
              <option value="NEW">Nouveaux clients (30j)</option>
              <option value="CHURN">Risque churn (90j)</option>
            </select>
            <button class="btn secondary" onclick="loadWorkflow('mark')"><i class="fas fa-rotate"></i> Charger workflow</button>
            <button class="btn" onclick="runWorkflow('mark')"><i class="fas fa-play"></i> Exécuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Emails (7j)</div><div class="stat-val" id="mSent">120k</div><span class="pill info">Klaviyo</span></div>
          <div class="card"><div class="muted">ROI Global</div><div class="stat-val" style="color:var(--success);" id="mROI">5.2x</div><span class="pill ok">Rentable</span></div>
          <div class="card"><div class="muted">Taux ouverture</div><div class="stat-val" id="mOpen">32%</div><span class="pill ok">Au-dessus médiane</span></div>
          <div class="card"><div class="muted">Alertes ROI</div><div class="stat-val" id="mAlerts">1</div><span class="pill warn">Seuil</span></div>
        </div>

        <div class="card" style="height:320px;margin-bottom:16px;">
          <canvas id="chartPromo"></canvas>
        </div>

        <div class="wf-wrap">
          <div class="wf-canvas" id="wfCanvasMark">
            <svg class="wf-svg" id="wfSvgMark"></svg>
            <div class="wf-nodes" id="wfNodesMark"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">Conversions</div><div class="v" id="mKpiConv">—</div></div>
                <div class="mini"><div class="k">CTR</div><div class="v" id="mKpiCTR">—</div></div>
                <div class="mini"><div class="k">ROAS</div><div class="v" id="mKpiROAS">—</div></div>
                <div class="mini"><div class="k">Budget pacing</div><div class="v" id="mKpiPacing">—</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermMark"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- NETCAREX -->
      <section id="care" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">NetCareX <span style="color:#666;font-size:1rem;">| Service Client</span></h2>
            <span class="pill info"><i class="fas fa-headset"></i> SLA & Retours</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="loadWorkflow('care')"><i class="fas fa-rotate"></i> Charger workflow</button>
            <button class="btn" onclick="runWorkflow('care')"><i class="fas fa-play"></i> Exécuter</button>
          </div>
        </div>

        <div class="grid-4">
          <div class="card"><div class="muted">Tickets ouverts</div><div class="stat-val" id="sOpen">24</div><span class="pill warn">File active</span></div>
          <div class="card"><div class="muted">SLA (24h)</div><div class="stat-val" id="sSLA">92%</div><span class="pill warn">À remonter</span></div>
          <div class="card"><div class="muted">First response</div><div class="stat-val" id="sFRT">1h 12m</div><span class="pill ok">Correct</span></div>
          <div class="card"><div class="muted">CSAT</div><div class="stat-val" style="color:var(--primary);" id="sCSAT">4.8/5</div><span class="pill ok">Top</span></div>
        </div>

        <div class="wf-wrap">
          <div class="wf-canvas" id="wfCanvasCare">
            <svg class="wf-svg" id="wfSvgCare"></svg>
            <div class="wf-nodes" id="wfNodesCare"></div>
          </div>

          <div class="wf-panel">
            <div class="card">
              <div class="toolbar">
                <div class="toolbar-left">
                  <h3 style="margin:0;">Console workflow</h3>
                  <span class="pill info"><i class="fas fa-terminal"></i> n8n</span>
                </div>
              </div>
              <div class="wf-mini">
                <div class="mini"><div class="k">TTR (résolution)</div><div class="v" id="sKpiTTR">—</div></div>
                <div class="mini"><div class="k">SLA breach</div><div class="v" id="sKpiBreach">—</div></div>
                <div class="mini"><div class="k">Automatisation</div><div class="v" id="sKpiAuto">—</div></div>
                <div class="mini"><div class="k">RMA générés</div><div class="v" id="sKpiRMA">—</div></div>
              </div>
              <div class="hr"></div>
              <div class="wf-term" id="wfTermCare"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h3>File Tickets (démo)</h3>
          <table class="data-table">
            <thead><tr><th>ID</th><th>Client</th><th>Motif</th><th>Priorité</th><th class="td-right">Actions</th></tr></thead>
            <tbody id="ticketsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- OPS -->
      <section id="ops" class="view-section">
        <div class="toolbar">
          <div class="toolbar-left">
            <h2 style="margin:0;">Audit & Conformité</h2>
            <span class="pill info"><i class="fas fa-shield-halved"></i> Audit Trail</span>
          </div>
          <div class="toolbar-right">
            <button class="btn secondary" onclick="exportAuditCSV()"><i class="fas fa-file-export"></i> Export Audit</button>
            <button class="btn" onclick="toast('ok','Conformité','Contrôles OK (démo).')"><i class="fas fa-check"></i> Run Checks</button>
          </div>
        </div>

        <div class="card">
          <h3>Journal d'audit (démo)</h3>
          <div class="muted" style="margin-bottom:10px;">Qui a fait quoi, quand, et sur quel outil. Oui, c’est la partie “adulte responsable”.</div>
          <table class="data-table">
            <thead><tr><th>Date</th><th>Utilisateur</th><th>Module</th><th>Action</th><th>Détail</th><th class="td-right">Niveau</th></tr></thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    /* =========================
       CLOCK
    ========================= */
    setInterval(()=> document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 500);

    /* =========================
       CHART
    ========================= */
    const ctxPromo = document.getElementById('chartPromo').getContext('2d');
    const promoChart = new Chart(ctxPromo, {
      type: 'line',
      data: {
        labels: ['L', 'M', 'M', 'J', 'V', 'S', 'D'],
        datasets: [{
          label: 'Ventes Campagne (€)',
          data: [1200, 1900, 3000, 5000, 4200, 6000, 7000],
          borderColor: '#d4af37',
          backgroundColor: 'rgba(212, 175, 55, 0.1)',
          fill: true,
          tension: .35
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales:{x:{ticks:{color:'#777'}},y:{ticks:{color:'#777'}}}
      }
    });

    function updateSegment(){
      const seg = document.getElementById('segmentSelect').value;
      if(seg==='VIP'){
        setText('mSent','120k'); setText('mROI','5.2x'); setText('mOpen','32%'); setText('mAlerts','1');
        promoChart.data.datasets[0].data = [1200,1900,3000,5000,4200,6000,7000];
      } else if(seg==='NEW'){
        setText('mSent','75k'); setText('mROI','3.1x'); setText('mOpen','38%'); setText('mAlerts','0');
        promoChart.data.datasets[0].data = [900,1400,2300,3400,3100,4200,4800];
      } else {
        setText('mSent','40k'); setText('mROI','2.4x'); setText('mOpen','26%'); setText('mAlerts','2');
        promoChart.data.datasets[0].data = [700,1100,1700,2100,2400,2600,2800];
      }
      promoChart.update();
      toast('info','Segment',`Segment actif: ${seg}`);
      audit('Admin','NetMarkX','UPDATE_SEGMENT',`Segment=${seg}`,'INFO');
      pushLog('NetMarkX','Segment',`Set=${seg}`,'OK');
    }

    /* =========================
       NAV
    ========================= */
    function nav(id, el) {
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
      document.getElementById('pageTitle').innerText = id.charAt(0).toUpperCase() + id.slice(1);

      const mod = id==='design'?'NetDesignX':id==='cat'?'NetCatX':id==='promo'?'NetMarkX':id==='care'?'NetCareX':id==='ops'?'OPS':'OPS';
      audit('Admin', mod, 'NAVIGATE', `to=${id}`, 'INFO');
      pushLog(mod,'Navigate',`to=${id}`,'OK');

      // Auto-load workflow once, for illustration
      if(id==='design') loadWorkflow('design');
      if(id==='cat') loadWorkflow('cat');
      if(id==='promo') loadWorkflow('mark');
      if(id==='care') loadWorkflow('care');
    }

    /* =========================
       UTIL
    ========================= */
    function setText(id, v){ const el=document.getElementById(id); if(el) el.innerText = v; }
    function fmt(n){ return n.toLocaleString('fr-CH'); }
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    /* =========================
       TOASTS
    ========================= */
    function toast(type, title, msg){
      const host = document.getElementById('toasts');
      const el = document.createElement('div');
      el.className = 'toast ' + (type||'info');
      el.innerHTML = `
        <div>
          <div class="t-title">${title}</div>
          <div class="t-msg">${msg}</div>
        </div>
        <button class="t-close" aria-label="close">&times;</button>
      `;
      el.querySelector('.t-close').onclick = ()=> el.remove();
      host.appendChild(el);
      setTimeout(()=> { if(el.isConnected) el.remove(); }, 4200);
    }

    /* =========================
       LOGS
    ========================= */
    const logs = [];
    const logsSeed = [
      {mod:'NetCatX', act:'Sync Shopify', det:'150 items', status:'OK'},
      {mod:'NetMarkX', act:'Email Sent', det:'Segment VIP', status:'OK'},
      {mod:'NetCareX', act:'Ticket Closed', det:'Refund #882', status:'OK'},
      {mod:'NetDesignX', act:'3D Render', det:'Veste Hiver', status:'OK'},
      {mod:'OPS', act:'Policy Check', det:'GDPR consent OK', status:'OK'},
      {mod:'NetCatX', act:'Rule Engine', det:'SEO title missing (SKU BST-2025)', status:'WARN'}
    ];

    function pushLog(mod, act, det, status='OK'){
      logs.unshift({ts:new Date(), mod, act, det, status});
      if(logs.length>80) logs.pop();
      renderLogs();
    }

    function renderLogs(){
      const q = (document.getElementById('logSearch').value||'').toLowerCase();
      const f = document.getElementById('logFilter').value;
      const rows = logs
        .filter(l => (f==='ALL' || l.mod===f))
        .filter(l => (`${l.mod} ${l.act} ${l.det}`.toLowerCase().includes(q)));

      const body = document.getElementById('logsBody');
      body.innerHTML = rows.slice(0,12).map(l=>{
        const st = l.status==='OK'
          ? `<span class="pill ok">OK</span>`
          : l.status==='WARN'
            ? `<span class="pill warn">WARN</span>`
            : `<span class="pill bad">FAIL</span>`;
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#9aa3ad;">${l.ts.toLocaleTimeString()}</td>
            <td><span style="color:var(--primary)">${l.mod}</span></td>
            <td>${l.act}</td>
            <td>${l.det}</td>
            <td class="td-right">${st}</td>
          </tr>`;
      }).join('');

      if(rows.length===0){
        body.innerHTML = `<tr><td colspan="5"><div class="empty">Aucun résultat.</div></td></tr>`;
      }
    }

    for(let i=0;i<10;i++){
      const s=pick(logsSeed);
      pushLog(s.mod,s.act,s.det,s.status);
    }
    setInterval(()=>{
      const s = pick(logsSeed);
      let det = s.det;
      if(s.mod==='NetCatX' && s.act==='Sync Shopify') det = `${rand(80,260)} items`;
      if(s.mod==='NetMarkX' && s.act==='Email Sent') det = `Batch ${fmt(rand(10_000, 55_000))}`;
      if(s.mod==='NetCareX' && s.act==='Ticket Closed') det = `Ticket #${rand(800,999)}`;
      pushLog(s.mod, s.act, det, s.status);
    }, 3600);

    function exportLogsCSV(){
      const header = ['timestamp','module','action','detail','status'];
      const lines = [header.join(',')].concat(
        logs.map(l => [
          l.ts.toISOString(),
          `"${l.mod}"`,
          `"${l.act}"`,
          `"${String(l.det).replaceAll('"','""')}"`,
          l.status
        ].join(','))
      );
      downloadFile('netmarket_logs.csv', lines.join('\n'));
      toast('ok','Export','CSV téléchargé: netmarket_logs.csv');
      audit('Admin','OPS','EXPORT','logs=csv','INFO');
    }

    function downloadFile(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    /* =========================
       AUDIT TRAIL
    ========================= */
    const auditEvents = [];
    function audit(user, module, action, detail, level){
      auditEvents.unshift({ts:new Date(), user, module, action, detail, level});
      if(auditEvents.length>60) auditEvents.pop();
      renderAudit();
    }
    function renderAudit(){
      const body = document.getElementById('auditBody');
      const rows = auditEvents.slice(0,14);
      body.innerHTML = rows.map(a=>{
        const pill = a.level==='WARN' ? 'warn' : (a.level==='ERROR'?'bad':'info');
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#9aa3ad;">${a.ts.toLocaleString()}</td>
            <td>${a.user}</td>
            <td><span style="color:var(--primary)">${a.module}</span></td>
            <td class="mono" style="font-size:.78rem;color:#cbd5e1;">${a.action}</td>
            <td>${a.detail}</td>
            <td class="td-right"><span class="pill ${pill}">${a.level}</span></td>
          </tr>`;
      }).join('');
      if(rows.length===0){
        body.innerHTML = `<tr><td colspan="6"><div class="empty">Aucun événement.</div></td></tr>`;
      }
    }
    function exportAuditCSV(){
      const header = ['timestamp','user','module','action','detail','level'];
      const lines = [header.join(',')].concat(
        auditEvents.map(a => [
          a.ts.toISOString(),
          `"${a.user}"`,
          `"${a.module}"`,
          `"${a.action}"`,
          `"${String(a.detail).replaceAll('"','""')}"`,
          a.level
        ].join(','))
      );
      downloadFile('netmarket_audit.csv', lines.join('\n'));
      toast('ok','Export','CSV téléchargé: netmarket_audit.csv');
    }

    /* =========================
       ENTERPRISE KPIs
    ========================= */
    function recalcEnterpriseKPIs(){
      const ttm = rand(10, 22);        // days
      const dq = (Math.random()*1.5).toFixed(2); // errors/1000
      const roi = (2 + Math.random()*4).toFixed(1);
      const sla = rand(88, 97);

      setText('kpiTTM', `${ttm} j`);
      setText('kpiDQ', `${dq} / 1000`);
      setText('kpiROI', `${roi}x`);
      setText('kpiSLA', `${sla}%`);

      toast('info','KPIs', 'KPIs recalculés (démo).');
      audit('Admin','OPS','KPI_RECALC',`ttm=${ttm}j dq=${dq}/1000 roi=${roi}x sla=${sla}%`,'INFO');
      pushLog('OPS','KPI','Recalc enterprise KPIs','OK');
    }
    recalcEnterpriseKPIs();

    /* =========================
       TICKETS (Support)
    ========================= */
    const tickets = [
      {id:'#1042', client:'Julie M.', motif:'Retour - taille', prio:'Haute'},
      {id:'#1043', client:'Karim S.', motif:'Livraison en retard', prio:'Moyenne'},
      {id:'#1044', client:'Emma R.', motif:'Facturation', prio:'Basse'},
      {id:'#1045', client:'Noah L.', motif:'Produit défectueux', prio:'Haute'}
    ];
    function renderTickets(){
      const body = document.getElementById('ticketsBody');
      body.innerHTML = tickets.map(t=>{
        const p = t.prio==='Haute' ? 'warn' : (t.prio==='Moyenne'?'info':'ok');
        return `
          <tr>
            <td class="mono" style="font-size:.78rem;color:#cbd5e1;">${t.id}</td>
            <td>${t.client}</td>
            <td>${t.motif}</td>
            <td><span class="pill ${p}">${t.prio}</span></td>
            <td class="td-right">
              <button class="btn secondary" style="padding:7px 10px" onclick="autoReply('${t.id}')"><i class="fas fa-wand-magic-sparkles"></i></button>
              <button class="btn secondary" style="padding:7px 10px" onclick="closeTicket('${t.id}')"><i class="fas fa-check"></i></button>
            </td>
          </tr>`;
      }).join('');
    }
    renderTickets();

    function autoReply(id){
      toast('info','Réponse IA',`Draft généré pour ${id} (démo).`);
      pushLog('NetCareX','AI Draft',`ticket=${id}`,'OK');
      audit('Admin','NetCareX','AI_DRAFT',`ticket=${id}`,'INFO');
    }
    function closeTicket(id){
      const i = tickets.findIndex(t=>t.id===id);
      if(i>=0) tickets.splice(i,1);
      renderTickets();
      toast('ok','Ticket',`${id} clos.`);
      pushLog('NetCareX','Ticket Closed',`${id}`,'OK');
      audit('Admin','NetCareX','CLOSE_TICKET',`ticket=${id}`,'INFO');
      const open = Math.max(0, parseInt(document.getElementById('sOpen').innerText,10)-1);
      setText('sOpen', String(open));
      const sla = Math.min(99, rand(90,96));
      setText('sSLA', `${sla}%`);
    }

    /* =========================
       WORKFLOW ENGINE (n8n-like)
       - Nodes + edges rendered
       - Drag nodes
       - Run animates path + terminal
    ========================= */
    let wfSpeed = 1;

    function wfSpeedToggle(){
      wfSpeed = (wfSpeed===1?2:(wfSpeed===2?3:1));
      document.getElementById('wfSpeedLbl').innerText = 'x'+wfSpeed;
      toast('info','Workflow',`Vitesse x${wfSpeed}`);
    }

    const ICON = {
      webhook:'fa-code-branch', cron:'fa-clock', file:'fa-file', db:'fa-database',
      validate:'fa-check', if:'fa-code-compare', code:'fa-code', doc:'fa-folder-open',
      approval:'fa-user-check', decision:'fa-circle-nodes', pim:'fa-tags',
      shopify:'fa-shopify', sheet:'fa-table', alert:'fa-bell', retry:'fa-rotate-right',
      dlq:'fa-inbox', monitor:'fa-chart-line', ticket:'fa-ticket', stop:'fa-ban',
      social:'fa-hashtag', klaviyo:'fa-paper-plane', analytics:'fa-chart-simple',
      classify:'fa-filter', lookup:'fa-magnifying-glass', rules:'fa-scale-balanced',
      refund:'fa-coins', shipping:'fa-truck-fast', notify:'fa-bullhorn', feedback:'fa-star'
    };

    const WORKFLOWS = {
      // Inspired by your screenshots (Design)
      design: {
        module: 'NetDesignX',
        canvasId: 'wfCanvasDesign',
        svgId: 'wfSvgDesign',
        nodesId: 'wfNodesDesign',
        termId: 'wfTermDesign',
        kpiSet: (metrics)=> {
          setText('dKpiCycle', metrics.cycle);
          setText('dKpiNoGo', metrics.nogo);
          setText('dKpiTickets', metrics.tickets);
          setText('dKpiHandoff', metrics.handoff);
        },
        nodes: [
          {id:'d1', x:28,  y:70,  type:'webhook', title:'Webhook', sub:'Collection validée'},
          {id:'d2', x:28,  y:170, type:'file',    title:'Trigger fichier', sub:'Tech pack / 3D'},
          {id:'d3', x:28,  y:270, type:'cron',    title:'Cron', sub:'Rappel validation'},
          {id:'d4', x:260, y:150, type:'doc',     title:'Capture & structuration', sub:'Set/Merge'},
          {id:'d5', x:470, y:150, type:'validate',title:'Validation', sub:'IF complet ?'},
          {id:'d6', x:680, y:150, type:'code',    title:'Normalisation', sub:'Mapping NetMarket'},
          {id:'d7', x:860, y:150, type:'doc',     title:'Gestion doc', sub:'Drive/SharePoint/S3'},
          {id:'d8', x:1040,y:150, type:'approval',title:'Approbation', sub:'Workflow approval'},
          {id:'d9', x:1220,y:150, type:'decision',title:'Décision', sub:'Go / No-Go (IF)'},
          {id:'d10',x:1400,y:70,  type:'retry',   title:'Retry', sub:'Relance'},
          {id:'d11',x:1400,y:150, type:'sheet',   title:'Journalisation & KPI', sub:'Logs + KPI'},
          {id:'d12',x:1400,y:230, type:'ticket',  title:'Ticket IT', sub:'Blocage'},
          {id:'d13',x:1220,y:260, type:'pim',     title:'Push vers PIM', sub:'Akeneo'},
          {id:'d14',x:1220,y:360, type:'stop',    title:'Stop/Log', sub:'No-Go'},
          {id:'d15',x:1040,y:300, type:'alert',   title:'Watcher Cron', sub:'Alerting & maintenance'}
        ],
        edges: [
          ['d1','d4'],['d2','d4'],['d3','d4'],
          ['d4','d5'],['d5','d6'],['d6','d7'],['d7','d8'],['d8','d9'],
          ['d9','d11'],['d11','d10'],['d10','d12'],['d12','d15'],
          ['d9','d13'],['d9','d14'],
          ['d15','d11']
        ],
        run: [
          {node:'d1', log:'WEBHOOK: Collection validée reçue'},
          {node:'d4', log:'CAPTURE: agrégation croquis + tech pack + metadata'},
          {node:'d5', log:'VALIDATION: champs obligatoires + tailles + matières'},
          {node:'d6', log:'NORMALISATION: mapping vers modèle NetMarket'},
          {node:'d7', log:'DOC: versioning & stockage centralisé'},
          {node:'d8', log:'APPROVAL: demande de validation chef de produit'},
          {node:'d9', log:'DECISION: Go/No-Go'},
          {node:'d13', log:'GO: push vers Akeneo + handoff Catalogue'},
          {node:'d11', log:'KPI: cycle time + taux complétude + traçabilité'}
        ]
      },

      // Inspired by your screenshots (Catalogue)
      cat: {
        module: 'NetCatX',
        canvasId: 'wfCanvasCat',
        svgId: 'wfSvgCat',
        nodesId: 'wfNodesCat',
        termId: 'wfTermCat',
        kpiSet: (metrics)=> {
          setText('cKpiSync', metrics.sync);
          setText('cKpiDup', metrics.dup);
          setText('cKpiDLQ', metrics.dlq);
          setText('cKpiPublish', metrics.publish);
        },
        nodes: [
          {id:'c1', x:28,  y:90,  type:'webhook', title:'Webhook', sub:'Collection validée'},
          {id:'c2', x:28,  y:190, type:'file',    title:'Trigger CSV', sub:'Nouveau fournisseur'},
          {id:'c3', x:28,  y:290, type:'cron',    title:'Cron', sub:'Synchro stock/prix'},
          {id:'c4', x:260, y:170, type:'doc',     title:'Set / Rename', sub:'Mapping champs'},
          {id:'c5', x:470, y:170, type:'validate',title:'Validation', sub:'Champs obligatoires'},
          {id:'c6', x:680, y:170, type:'code',    title:'Normalisation', sub:'Tailles/couleurs/matières'},
          {id:'c7', x:900, y:170, type:'if',      title:'IF doublons', sub:'Produit existe ?'},
          {id:'c8', x:1120,y:90,  type:'pim',     title:'Akeneo (Create)', sub:'Produit + variantes'},
          {id:'c9', x:1120,y:250, type:'pim',     title:'Akeneo (Update)', sub:'Update produit'},
          {id:'c10',x:1320,y:170, type:'shopify', title:'HTTP Shopify', sub:'Publication produit'},
          {id:'c11',x:1520,y:170, type:'sheet',   title:'Journalisation', sub:'Log (Sheet/DB/Notion)'},
          {id:'c12',x:900, y:330, type:'retry',   title:'Retry x3', sub:'Maintenance'},
          {id:'c13',x:1120,y:330, type:'dlq',     title:'Dead-letter', sub:'Stocker échecs'},
          {id:'c14',x:1320,y:330, type:'alert',   title:'Alerting', sub:'Email/Teams/Ticket IT'},
          {id:'c15',x:1520,y:330, type:'monitor', title:'Monitoring', sub:'Rapport quotidien'}
        ],
        edges: [
          ['c1','c4'],['c2','c4'],['c3','c4'],
          ['c4','c5'],['c5','c6'],['c6','c7'],
          ['c7','c8'],['c7','c9'],
          ['c8','c10'],['c9','c10'],
          ['c10','c11'],
          ['c10','c12'],['c12','c13'],['c13','c14'],['c14','c15'],['c15','c11']
        ],
        run: [
          {node:'c2', log:'TRIGGER: nouveau CSV fournisseur détecté'},
          {node:'c4', log:'MAPPING: rename fields → modèle NetMarket'},
          {node:'c5', log:'VALIDATION: attributs obligatoires + images + prix'},
          {node:'c6', log:'NORMALISATION: tailles EU/US + matières + coloris'},
          {node:'c7', log:'DEDUP: create vs update'},
          {node:'c8', log:'PIM: création produit + variantes (Akeneo)'},
          {node:'c10',log:'PUBLISH: push Shopify (HTTP request)'},
          {node:'c11',log:'LOG: journalisation + KPI data quality'}
        ]
      },

      // Inspired by your screenshots (Marketing)
      mark: {
        module: 'NetMarkX',
        canvasId: 'wfCanvasMark',
        svgId: 'wfSvgMark',
        nodesId: 'wfNodesMark',
        termId: 'wfTermMark',
        kpiSet: (metrics)=> {
          setText('mKpiConv', metrics.conv);
          setText('mKpiCTR', metrics.ctr);
          setText('mKpiROAS', metrics.roas);
          setText('mKpiPacing', metrics.pacing);
        },
        nodes: [
          {id:'m1', x:28,  y:110, type:'webhook',  title:'Webhook', sub:'Nouvelle collection publiée'},
          {id:'m2', x:28,  y:230, type:'cron',     title:'Cron', sub:'Calendrier campagnes'},
          {id:'m3', x:28,  y:350, type:'shopify',  title:'Trigger Shopify', sub:'Panier/achat/retour'},
          {id:'m4', x:260, y:230, type:'if',       title:'Segment Builder', sub:'VIP / nouveaux / inactifs'},
          {id:'m5', x:500, y:230, type:'db',       title:'Data Enrichment', sub:'GA4 / Shopify / CRM'},
          {id:'m6', x:740, y:150, type:'klaviyo',  title:'Klaviyo', sub:'Créer campagne / flow'},
          {id:'m7', x:740, y:310, type:'social',   title:'Social Scheduling', sub:'Buffer/Hootsuite'},
          {id:'m8', x:980, y:230, type:'analytics',title:'Tracking & KPI', sub:'ROI / CTR / conversions'},
          {id:'m9', x:1220,y:230, type:'sheet',    title:'Dashboard Log', sub:'Sheet/DB'},
          {id:'m10',x:1450,y:230, type:'if',       title:'Alerting (IF)', sub:'ROI < seuil ?'},
          {id:'m11',x:1660,y:150, type:'alert',    title:'Notification', sub:'Marketing'},
          {id:'m12',x:1660,y:310, type:'monitor',  title:'Maintenance', sub:'UTM/budget/rapport'}
        ],
        edges: [
          ['m1','m4'],['m2','m4'],['m3','m4'],
          ['m4','m5'],['m5','m6'],['m5','m7'],
          ['m6','m8'],['m7','m8'],
          ['m8','m9'],['m9','m10'],
          ['m10','m11'],['m10','m12'],['m12','m9']
        ],
        run: [
          {node:'m1', log:'WEBHOOK: collection publiée → démarrage campagne'},
          {node:'m4', log:'SEGMENT: VIP / nouveaux / inactifs'},
          {node:'m5', log:'ENRICH: GA4 + Shopify + CRM'},
          {node:'m6', log:'Klaviyo: création campagne + scheduling'},
          {node:'m7', log:'Social: planification posts (Buffer/Hootsuite)'},
          {node:'m8', log:'TRACKING: CTR, conversions, ROI (GA4/Meta)'},
          {node:'m10',log:'ALERT IF: ROI sous seuil → suggestion stop/optimisation'},
          {node:'m9', log:'DASHBOARD: journalisation et mise à jour KPI'}
        ]
      },

      // Inspired by your screenshots (Service Client)
      care: {
        module: 'NetCareX',
        canvasId: 'wfCanvasCare',
        svgId: 'wfSvgCare',
        nodesId: 'wfNodesCare',
        termId: 'wfTermCare',
        kpiSet: (metrics)=> {
          setText('sKpiTTR', metrics.ttr);
          setText('sKpiBreach', metrics.breach);
          setText('sKpiAuto', metrics.auto);
          setText('sKpiRMA', metrics.rma);
        },
        nodes: [
          {id:'s1', x:28,  y:90,  type:'webhook',  title:'Webhook', sub:'Zendesk/Gorgias ticket créé'},
          {id:'s2', x:28,  y:210, type:'shopify',  title:'Trigger Shopify', sub:'RMA / retour'},
          {id:'s3', x:28,  y:330, type:'cron',     title:'Cron', sub:'Relance satisfaction J+3'},
          {id:'s4', x:260, y:210, type:'classify', title:'Classifier (IA/IF)', sub:'retour/taille/remb.'},
          {id:'s5', x:500, y:210, type:'lookup',   title:'Lookup Order', sub:'Shopify'},
          {id:'s6', x:740, y:210, type:'rules',    title:'Règles de gestion', sub:'<30j ? défaut ?'},
          {id:'s7', x:980, y:90,  type:'shipping', title:'Retour standard', sub:'Étiquette + email'},
          {id:'s8', x:980, y:210, type:'doc',      title:'Échange taille', sub:'Nouvelle commande + stock'},
          {id:'s9', x:980, y:330, type:'refund',   title:'Remboursement', sub:'Déclencher'},
          {id:'s10',x:1220,y:210, type:'doc',      title:'Update Ticket', sub:'notes, SLA, tags'},
          {id:'s11',x:1450,y:90,  type:'notify',   title:'Notification interne', sub:'logistique/qualité/finance'},
          {id:'s12',x:1450,y:210, type:'sheet',    title:'Journalisation', sub:'log temps/action'},
          {id:'s13',x:1450,y:330, type:'if',       title:'Alerting (IF)', sub:'SLA dépassé ?'},
          {id:'s14',x:1680,y:330, type:'alert',    title:'Escalade', sub:'responsable support'},
          {id:'s15',x:1220,y:360, type:'feedback', title:'Customer feedback', sub:'CSAT/NPS'}
        ],
        edges: [
          ['s1','s4'],['s2','s4'],['s3','s15'],
          ['s4','s5'],['s5','s6'],
          ['s6','s7'],['s6','s8'],['s6','s9'],
          ['s7','s10'],['s8','s10'],['s9','s10'],
          ['s10','s11'],['s10','s12'],['s12','s13'],['s13','s14'],
          ['s10','s15']
        ],
        run: [
          {node:'s1', log:'WEBHOOK: ticket créé (Zendesk/Gorgias)'},
          {node:'s4', log:'CLASSIF: retour vs échange vs remboursement'},
          {node:'s5', log:'LOOKUP: récupération commande Shopify'},
          {node:'s6', log:'RULES: délai retour / produit défectueux / SLA'},
          {node:'s7', log:'ACTION: étiquette retour + email'},
          {node:'s10',log:'UPDATE: ticket + statut + tags + SLA'},
          {node:'s12',log:'LOG: temps de traitement + KPI'},
          {node:'s15',log:'CSAT: envoi survey satisfaction'}
        ]
      }
    };

    // Node drag registry
    const dragState = {active:false, wfKey:null, nodeId:null, dx:0, dy:0};

    function loadWorkflow(key){
      const wf = WORKFLOWS[key];
      if(!wf) return;

      const canvas = document.getElementById(wf.canvasId);
      const svg = document.getElementById(wf.svgId);
      const nodesHost = document.getElementById(wf.nodesId);
      const term = document.getElementById(wf.termId);

      // Reset
      nodesHost.innerHTML = '';
      svg.innerHTML = '';
      term.innerHTML = '';
      wf.nodes.forEach(n => n._status = 'idle');

      // Create nodes
      for(const n of wf.nodes){
        const div = document.createElement('div');
        div.className = 'node';
        div.style.left = n.x + 'px';
        div.style.top  = n.y + 'px';
        div.dataset.id = n.id;
        const ic = ICON[n.type] || 'fa-circle';
        div.innerHTML = `
          <div class="ic"><i class="fas ${ic}"></i></div>
          <div class="t">
            <div class="title">${n.title}</div>
            <div class="sub">${n.sub}</div>
          </div>
          <div class="badge idle">IDLE</div>
        `;
        div.addEventListener('mousedown', (e)=> startDrag(e, key, n.id));
        nodesHost.appendChild(div);
      }

      // Draw edges
      drawEdges(key);

      // Baseline KPIs in panels
      if(key==='design'){
        wf.kpiSet({cycle:'—', nogo:'—', tickets:'—', handoff:'—'});
        termLog(key, '>> Workflow chargé (NetDesignX).');
      }
      if(key==='cat'){
        wf.kpiSet({sync:'—', dup:'—', dlq:'—', publish:'—'});
        termLog(key, '>> Workflow chargé (NetCatX).');
      }
      if(key==='mark'){
        wf.kpiSet({conv:'—', ctr:'—', roas:'—', pacing:'—'});
        termLog(key, '>> Workflow chargé (NetMarkX).');
      }
      if(key==='care'){
        wf.kpiSet({ttr:'—', breach:'—', auto:'—', rma:'—'});
        termLog(key, '>> Workflow chargé (NetCareX).');
      }

      toast('ok','Workflow',`${wf.module} chargé.`);
      audit('Admin', wf.module, 'WF_LOAD', 'workflow loaded', 'INFO');
      pushLog(wf.module, 'Workflow', 'Loaded', 'OK');
    }

    function drawEdges(key){
      const wf = WORKFLOWS[key];
      const svg = document.getElementById(wf.svgId);
      const nodesHost = document.getElementById(wf.nodesId);

      const rect = nodesHost.getBoundingClientRect();

      const getNodeEl = (id)=> nodesHost.querySelector(`.node[data-id="${id}"]`);

      const width = nodesHost.clientWidth;
      const height = nodesHost.clientHeight;
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);

      // defs (arrow)
      svg.innerHTML = `
        <defs>
          <marker id="arrow-${key}" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(212,175,55,.55)"></path>
          </marker>
        </defs>
      `;

      for(const [from,to] of wf.edges){
        const a = getNodeEl(from);
        const b = getNodeEl(to);
        if(!a || !b) continue;

        const ax = a.offsetLeft + a.offsetWidth;
        const ay = a.offsetTop  + a.offsetHeight/2;
        const bx = b.offsetLeft;
        const by = b.offsetTop  + b.offsetHeight/2;

        const mx = (ax + bx)/2;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M ${ax} ${ay} C ${mx} ${ay}, ${mx} ${by}, ${bx} ${by}`);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','rgba(212,175,55,.35)');
        path.setAttribute('stroke-width','2');
        path.setAttribute('marker-end', `url(#arrow-${key})`);
        svg.appendChild(path);
      }
    }

    function startDrag(e, key, nodeId){
      dragState.active = true;
      dragState.wfKey = key;
      dragState.nodeId = nodeId;

      const wf = WORKFLOWS[key];
      const host = document.getElementById(wf.nodesId);
      const el = host.querySelector(`.node[data-id="${nodeId}"]`);
      if(!el) return;

      const rect = el.getBoundingClientRect();
      dragState.dx = e.clientX - rect.left;
      dragState.dy = e.clientY - rect.top;
      el.style.cursor = 'grabbing';
    }
    window.addEventListener('mousemove', (e)=>{
      if(!dragState.active) return;
      const wf = WORKFLOWS[dragState.wfKey];
      const host = document.getElementById(wf.nodesId);
      const el = host.querySelector(`.node[data-id="${dragState.nodeId}"]`);
      if(!el) return;

      const hostRect = host.getBoundingClientRect();
      let x = e.clientX - hostRect.left - dragState.dx;
      let y = e.clientY - hostRect.top  - dragState.dy;

      x = Math.max(6, Math.min(x, host.clientWidth - el.offsetWidth - 6));
      y = Math.max(6, Math.min(y, host.clientHeight - el.offsetHeight - 6));

      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      drawEdges(dragState.wfKey);
    });
    window.addEventListener('mouseup', ()=>{
      if(!dragState.active) return;
      const wf = WORKFLOWS[dragState.wfKey];
      const host = document.getElementById(wf.nodesId);
      const el = host.querySelector(`.node[data-id="${dragState.nodeId}"]`);
      if(el) el.style.cursor = 'grab';
      dragState.active=false; dragState.wfKey=null; dragState.nodeId=null;
    });

    function setNodeStatus(key, nodeId, status){
      const wf = WORKFLOWS[key];
      const host = document.getElementById(wf.nodesId);
      const el = host.querySelector(`.node[data-id="${nodeId}"]`);
      if(!el) return;
      el.classList.remove('active','ok','warn','fail');
      const badge = el.querySelector('.badge');
      badge.classList.remove('ok','warn','fail','idle');

      if(status==='active'){
        el.classList.add('active');
        badge.classList.add('idle');
        badge.textContent = 'RUN';
      } else if(status==='ok'){
        el.classList.add('ok');
        badge.classList.add('ok');
        badge.textContent = 'OK';
      } else if(status==='warn'){
        el.classList.add('warn');
        badge.classList.add('warn');
        badge.textContent = 'WARN';
      } else if(status==='fail'){
        el.classList.add('fail');
        badge.classList.add('fail');
        badge.textContent = 'FAIL';
      } else {
        badge.classList.add('idle');
        badge.textContent = 'IDLE';
      }
    }

    function termLog(key, text){
      const wf = WORKFLOWS[key];
      const term = document.getElementById(wf.termId);
      const time = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.className = 'term-line';
      line.innerHTML = `<span class="term-time">[${time}]</span><span class="term-text">${text}</span>`;
      term.appendChild(line);
      term.scrollTop = term.scrollHeight;
    }

    let wfRunLock = false;

    function runWorkflow(key){
      if(wfRunLock){ toast('warn','Workflow','Déjà en cours… laissez-le respirer.'); return; }
      const wf = WORKFLOWS[key];
      if(!wf) return;

      wfRunLock = true;
      termLog(key, `>> EXECUTION START (${wf.module})`);
      audit('Admin', wf.module, 'WF_RUN', 'execution start', 'INFO');
      pushLog(wf.module, 'Workflow', 'Run start', 'OK');

      // Reset statuses
      wf.nodes.forEach(n=> setNodeStatus(key, n.id, 'idle'));

      const stepDelay = Math.round(1200 / wfSpeed);

      // Simulated outcomes per workflow
      const outcome = buildOutcome(key);

      wf.run.forEach((step, i)=>{
        setTimeout(()=>{
          // Active
          setNodeStatus(key, step.node, 'active');
          termLog(key, step.log);

          // Make some steps warn/fail to illustrate maintenance paths (rare)
          const verdict = outcome.verdicts[step.node] || 'ok';
          // close previous node to ok
          if(i>0){
            const prev = wf.run[i-1].node;
            const prevVerdict = outcome.verdicts[prev] || 'ok';
            setNodeStatus(key, prev, prevVerdict);
          }

          // end
          if(i === wf.run.length - 1){
            setTimeout(()=>{
              setNodeStatus(key, step.node, verdict);
              termLog(key, `>> KPIs: ${outcome.kpiLine}`);
              termLog(key, `>> EXECUTION END (${verdict.toUpperCase()})`);

              // Update workflow KPIs panel
              wf.kpiSet(outcome.panel);

              // Update enterprise KPIs lightly
              bumpEnterpriseKPIsFromRun(key, outcome);

              // Logs + audit
              pushLog(wf.module,'WF_RESULT', outcome.kpiLine, verdict==='ok'?'OK':'WARN');
              audit('Admin', wf.module, 'WF_RESULT', outcome.kpiLine, verdict==='ok'?'INFO':'WARN');

              toast(verdict==='ok'?'ok':'warn', 'Workflow', `${wf.module} terminé — KPIs générés.`);
              wfRunLock = false;
            }, Math.round(900 / wfSpeed));
          }
        }, i * stepDelay);
      });
    }

    function buildOutcome(key){
      // KPIs + light randomness, aligned with each department
      if(key==='design'){
        const cycleMin = rand(18, 52);
        const nogo = rand(6, 18);
        const tickets = (Math.random()<0.2)? 1 : 0;
        const handoff = (100 - rand(2,10)) + '%';
        const verdicts = {};
        if(tickets===1){ verdicts['d12']='warn'; verdicts['d15']='warn'; }
        return {
          verdicts,
          panel: {cycle: `${cycleMin} min`, nogo: `${nogo}%`, tickets: `${tickets}`, handoff},
          kpiLine: `cycle_time=${cycleMin}min | nogo=${nogo}% | tickets_it=${tickets} | handoff=${handoff}`
        };
      }
      if(key==='cat'){
        const sync = rand(95, 100);
        const dup = rand(0, 7);
        const dlq = (Math.random()<0.15)? rand(1,4) : 0;
        const publish = rand(8, 22) + ' min';
        const verdicts = {};
        if(dlq>0){ verdicts['c13']='warn'; verdicts['c14']='warn'; verdicts['c15']='warn'; }
        return {
          verdicts,
          panel: {sync: `${sync}%`, dup: `${dup}`, dlq: `${dlq}`, publish},
          kpiLine: `sync_success=${sync}% | duplicates=${dup} | dead_letter=${dlq} | publish_time=${publish}`
        };
      }
      if(key==='mark'){
        const conv = fmt(rand(420, 1450));
        const ctr = (Math.random()*1.8 + 1.2).toFixed(2) + provePercent();
        const roas = (Math.random()*4 + 1.8).toFixed(1) + 'x';
        const pacing = (rand(92, 108)) + '%';
        const lowRoi = parseFloat(roas) < 2.6;
        const verdicts = {};
        if(lowRoi){ verdicts['m10']='warn'; verdicts['m11']='warn'; }
        return {
          verdicts,
          panel: {conv, ctr, roas, pacing},
          kpiLine: `conversions=${conv} | ctr=${ctr} | roas=${roas} | budget_pacing=${pacing}`
        };
      }
      if(key==='care'){
        const ttr = rand(35, 210) + ' min';
        const breach = (Math.random()<0.18)? fmt(rand(8, 42)) : '0';
        const auto = rand(25, 62) + '%';
        const rma = fmt(rand(60, 240));
        const verdicts = {};
        if(breach!=='0'){ verdicts['s13']='warn'; verdicts['s14']='warn'; }
        return {
          verdicts,
          panel: {ttr, breach, auto, rma},
          kpiLine: `ttr=${ttr} | sla_breach=${breach} | auto_resolution=${auto} | rma=${rma}`
        };
      }
      return {verdicts:{}, panel:{}, kpiLine:'n/a'};
    }
    function provePercent(){ return '%'; }

    function bumpEnterpriseKPIsFromRun(key, outcome){
      // This gives you a “global dashboard effect” when you run workflows
      if(key==='design'){
        setText('kpiTTM', `${rand(10,20)} j`);
      }
      if(key==='cat'){
        setText('kpiDQ', `${(Math.random()*1.4).toFixed(2)} / 1000`);
      }
      if(key==='mark'){
        setText('kpiROI', `${(2 + Math.random()*4).toFixed(1)}x`);
      }
      if(key==='care'){
        setText('kpiSLA', `${rand(88,97)}%`);
      }
    }

    /* =========================
       INIT: load default workflows when opening each page
    ========================= */
    audit('System','OPS','BOOT','titan-v8.workflow-suite ready','INFO');
    audit('Admin','NetDesignX','POLICY','Gate validation + approval + Go/No-Go','INFO');
    audit('Admin','NetCatX','POLICY','PIM single source of truth + DLQ','INFO');
    audit('Admin','NetMarkX','POLICY','ROI threshold alerting','INFO');
    audit('Admin','NetCareX','POLICY','SLA monitoring + escalation','INFO');

    // Preload design workflow first time for illustration
    loadWorkflow('design');

    /* Small cosmetic default KPIs */
    setText('kpiTTM', '—');
    setText('kpiDQ', '—');
    setText('kpiROI', '—');
    setText('kpiSLA', '—');
  </script>
</body>
</html>
